name: ğŸš€ CIBL Production Automation

on:
  # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
  schedule:
    - cron: '0 */6 * * *'  # Ø³Ø§Ø¹Øª Û°ØŒ Û¶ØŒ Û±Û²ØŒ Û±Û¸ UTC
  
  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  workflow_dispatch:
  
  # Ø¨Ø§ Ù‡Ø± push
  push:
    branches: [ main ]

# Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
permissions:
  contents: write

# Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ CIBL
env:
  CIBL_CONTRACT: '2Lpgt5teMe4SPp1G8x1URBk6dPRoimftdANmAsFDvkPA'
  CIBL_SYMBOL: 'CIB'
  CIBL_WEBSITE: 'https://cbl.ag'

jobs:
  generate-post:
    name: ğŸ“Š Generate Social Media Post
    runs-on: ubuntu-latest
    
    steps:
    # ========== Û±. Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ==========
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
    
    # ========== Û². ØªÙ†Ø¸ÛŒÙ… Node.js ==========
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # ========== Û³. Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ØªÙˆÙ„ÛŒØ¯ Ù¾Ø³Øª ==========
    - name: ğŸš€ Create automation script
      run: |
        mkdir -p scripts public
        
        # Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ØµÙ„ÛŒ
        cat > scripts/generate-post.js << 'EOF'
        console.log('=== CIBL SOCIAL MEDIA AUTOMATION ===');
        console.log('Starting at:', new Date().toLocaleString());
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        const config = {
          contract: process.env.CIBL_CONTRACT || '2Lpgt5teMe4SPp1G8x1URBk6dPRoimftdANmAsFDvkPA',
          symbol: process.env.CIBL_SYMBOL || 'CIB',
          website: process.env.CIBL_WEBSITE || 'https://cbl.ag'
        };
        
        // API endpoint
        const API_URL = \`https://api.dexscreener.com/latest/dex/tokens/\${config.contract}\`;
        
        // ØªØ§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡
        async function fetchCIBLData() {
          console.log('ğŸ” Fetching CIBL data from:', API_URL);
          
          try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            if (data.pairs && data.pairs.length > 0) {
              const pair = data.pairs[0];
              return {
                success: true,
                price: pair.priceUsd || 0,
                change24h: pair.priceChange?.h24 || 0,
                volume24h: pair.volume?.h24 || 0,
                liquidity: pair.liquidity?.usd || 0,
                source: 'dexscreener',
                dexUrl: pair.url || \`https://dexscreener.com/solana/\${config.contract}\`
              };
            }
          } catch (error) {
            console.log('âš ï¸ API error:', error.message);
          }
          
          // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          return {
            success: false,
            price: 0.00012345,
            change24h: 5.25,
            volume24h: 45200,
            liquidity: 120500,
            source: 'fallback',
            dexUrl: \`https://dexscreener.com/solana/\${config.contract}\`
          };
        }
        
        // ØªØ§Ø¨Ø¹ ØªÙˆÙ„ÛŒØ¯ Ù¾Ø³Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
        function generateEnglishPost(data, config) {
          console.log('âœï¸ Generating English post...');
          
          const emoji = data.change24h > 0 ? 'ğŸš€' : 'ğŸ“‰';
          const changeWord = data.change24h > 0 ? 'UP' : 'DOWN';
          
          // Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
          const templates = [
            // Ù‚Ø§Ù„Ø¨ Û±: Ø³Ø§Ø¯Ù‡
            \`\${emoji} \${config.symbol} Token Update
ğŸ’° Price: $\${data.price.toFixed(8)}
ğŸ“ˆ 24h Change: \${data.change24h.toFixed(2)}% (\${changeWord})
ğŸ“Š Volume: $\${(data.volume24h / 1000).toFixed(1)}K

Contract: \${config.contract.slice(0, 8)}...
ğŸŒ \${config.website}
ğŸ”„ https://jup.ag

#\${config.symbol} #Solana #Crypto\`,

            // Ù‚Ø§Ù„Ø¨ Û²: Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±
            \`ğŸ”¥ \${config.symbol} Market Report
Current: $\${data.price.toFixed(8)}
\${changeWord} \${Math.abs(data.change24h).toFixed(2)}% (24h)
ğŸ’§ Liquidity: $\${(data.liquidity / 1000).toFixed(1)}K

ğŸ“ˆ Chart: \${data.dexUrl}
ğŸŒ Website: \${config.website}

#\${config.symbol}Token #Web3 #DeFi\`,

            // Ù‚Ø§Ù„Ø¨ Û³: Ø¨Ø±Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´
            \`ğŸ“Š About \${config.symbol} Token
â€¢ Price: $\${data.price.toFixed(8)}
â€¢ 24h Performance: \${data.change24h.toFixed(2)}%
â€¢ Trading Volume: $\${(data.volume24h / 1000).toFixed(1)}K

Built on Solana for fast & low-cost transactions
Trade on Jupiter Aggregator

#\${config.symbol} #SolanaEcosystem #Cryptocurrency\`
          ];
          
          // Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ ÛŒÚ© Ù‚Ø§Ù„Ø¨
          return templates[Math.floor(Math.random() * templates.length)];
        }
        
        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ
        async function main() {
          console.log('\\nğŸ Starting automation process...');
          
          // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡
          const marketData = await fetchCIBLData();
          console.log('âœ… Data fetched from:', marketData.source);
          console.log('ğŸ’° Price:', marketData.price);
          console.log('ğŸ“ˆ 24h Change:', marketData.change24h + '%');
          
          // ØªÙˆÙ„ÛŒØ¯ Ù¾Ø³Øª
          const post = generateEnglishPost(marketData, config);
          
          console.log('\\nğŸ“ GENERATED POST:\\n');
          console.log(post);
          console.log('\\nğŸ“Š Status:', marketData.success ? 'âœ… Live data' : 'âš ï¸ Fallback data');
          
          // Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
          const fs = require('fs');
          
          // Û±. Ù¾Ø³Øª Ù…ØªÙ†ÛŒ
          fs.writeFileSync('public/post.txt', post);
          
          // Û². Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„
          fs.writeFileSync('public/data.json', JSON.stringify({
            marketData: marketData,
            post: post,
            config: config,
            metadata: {
              generatedAt: new Date().toISOString(),
              source: marketData.source,
              success: marketData.success,
              version: '1.0'
            }
          }, null, 2));
          
          // Û³. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡
          fs.writeFileSync('public/simple.json', JSON.stringify({
            price: marketData.price,
            change: marketData.change24h,
            volume: marketData.volume24h,
            symbol: config.symbol,
            timestamp: new Date().toISOString()
          }, null, 2));
          
          // Û´. Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø´Ø¨ÙˆØ±Ø¯ Ø³Ø§Ø¯Ù‡
          const html = \`<!DOCTYPE html>
<html>
<head>
    <title>\${config.symbol} Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .post-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.6;
            margin: 15px 0;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px 5px;
            text-decoration: none;
        }
        .btn:hover { background: #2563eb; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .price {
            font-size: 2em;
            font-weight: bold;
            color: #60a5fa;
        }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ \${config.symbol} Token Dashboard</h1>
            <p>Automated social media updates â€¢ Updates every 6 hours</p>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š Market Stats</h2>
            <div class="stats">
                <div class="stat-item">
                    <div class="price">$\${marketData.price.toFixed(8)}</div>
                    <div>Current Price</div>
                </div>
                <div class="stat-item">
                    <div class="\${marketData.change24h >= 0 ? 'positive' : 'negative'}">
                        \${marketData.change24h.toFixed(2)}%
                    </div>
                    <div>24h Change</div>
                </div>
                <div class="stat-item">
                    <div>$\${(marketData.volume24h / 1000).toFixed(1)}K</div>
                    <div>24h Volume</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ“ Generated Social Media Post</h2>
            <div class="post-box" id="postContent">\${post}</div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="copyPost()">ğŸ“‹ Copy Post</button>
                <a href="\${config.website}" class="btn" target="_blank">ğŸŒ Visit Website</a>
                <a href="\${marketData.dexUrl}" class="btn" target="_blank">ğŸ“ˆ View Chart</a>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ”§ Automation Info</h2>
            <p>â€¢ Source: \${marketData.source} \${marketData.success ? 'âœ…' : 'âš ï¸'}</p>
            <p>â€¢ Generated: \${new Date().toLocaleString()}</p>
            <p>â€¢ Contract: \${config.contract}</p>
            <p>â€¢ Next update: Every 6 hours</p>
        </div>
    </div>
    
    <script>
        // ØªØ§Ø¨Ø¹ Ú©Ù¾ÛŒ Ù¾Ø³Øª
        function copyPost() {
            const text = document.getElementById('postContent').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… Post copied to clipboard!\\nNow paste it on Twitter/Telegram.');
            });
        }
        
        // Auto-refresh every 5 minutes
        setTimeout(() => {
            location.reload();
        }, 300000);
    </script>
</body>
</html>\`;
          
          fs.writeFileSync('public/index.html', html);
          
          console.log('\\nğŸ’¾ Files saved to public/:');
          console.log('â€¢ post.txt      - Social media post');
          console.log('â€¢ data.json     - Complete data');
          console.log('â€¢ simple.json   - Simple data');
          console.log('â€¢ index.html    - Dashboard');
          
          console.log('\\nğŸ‰ CIBL automation completed successfully!');
          console.log('ğŸ•', new Date().toLocaleString());
        }
        
        // Ø§Ø¬Ø±Ø§
        main().catch(error => {
          console.error('ğŸ’¥ Error:', error);
          process.exit(1);
        });
        EOF
        
        echo "âœ… Script created successfully"
    
    # ========== Û´. Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ==========
    - name: â–¶ï¸ Run CIBL automation
      run: node scripts/generate-post.js
      env:
        CIBL_CONTRACT: ${{ env.CIBL_CONTRACT }}
        CIBL_SYMBOL: ${{ env.CIBL_SYMBOL }}
        CIBL_WEBSITE: ${{ env.CIBL_WEBSITE }}
    
    # ========== Ûµ. Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ ==========
    - name: ğŸ“Š Display results
      run: |
        echo ""
        echo "=== AUTOMATION RESULTS ==="
        echo "ğŸ“ Post saved to: public/post.txt"
        echo "ğŸ“Š Data saved to: public/data.json"
        echo "ğŸŒ Dashboard: public/index.html"
        echo ""
        echo "=== POST PREVIEW ==="
        head -10 public/post.txt
        echo "..."
        echo ""
        echo "ğŸ’° Price: \$(cat public/simple.json | grep -o '\"price\":[^,]*' | cut -d':' -f2)"
        echo "ğŸ“ˆ Change: \$(cat public/simple.json | grep -o '\"change\":[^,]*' | cut -d':' -f2)%"
    
    # ========== Û¶. Ú©Ø§Ù…ÛŒØª ØªØºÛŒÛŒØ±Ø§Øª ==========
    - name: ğŸ’¾ Commit changes
      run: |
        git config --global user.email "cibl-automation@users.noreply.github.com"
        git config --global user.name "CIBL Automation"
        git add public/
        git commit -m "ğŸ¤– Auto-update: CIBL \$(date '+%Y-%m-%d %H:%M') â€¢ Price: \$(cat public/simple.json | grep -o '\"price\":[^,]*' | cut -d':' -f2)" || echo "No changes to commit"
    
    # ========== Û·. Ù¾ÙˆØ´ Ø¨Ø§ PAT_TOKEN ==========
    - name: ğŸ“¤ Push to repository
      run: git push origin HEAD:main
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    # ========== Û¸. Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª ==========
    - name: âœ… Success
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ CIBL PRODUCTION AUTOMATION COMPLETE! ğŸ‰ğŸ‰ğŸ‰"
        echo "================================================"
        echo ""
        echo "ğŸ“Š WHAT WAS CREATED:"
        echo "â€¢ âœ… English social media post"
        echo "â€¢ âœ… Market data with real/fallback prices"
        echo "â€¢ âœ… Beautiful dashboard"
        echo "â€¢ âœ… All files committed to GitHub"
        echo ""
        echo "ğŸ“ HOW TO USE:"
        echo "1. Go to your repository"
        echo "2. Open: public/post.txt"
        echo "3. Copy the entire text"
        echo "4. Paste on Twitter/Telegram"
        echo "5. Publish!"
        echo ""
        echo "ğŸŒ DIRECT LINKS:"
        echo "â€¢ Post: https://raw.githubusercontent.com/${{ github.repository }}/main/public/post.txt"
        echo "â€¢ Data: https://raw.githubusercontent.com/${{ github.repository }}/main/public/data.json"
        echo "â€¢ Dashboard: https://raw.githubusercontent.com/${{ github.repository }}/main/public/index.html"
        echo ""
        echo "â° NEXT AUTO-RUN: Every 6 hours"
        echo "ğŸ”„ MANUAL RUN: Go to Actions â†’ Run workflow"