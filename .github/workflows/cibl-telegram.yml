name: CIBL Telegram Promotion

on:
  workflow_dispatch:
    inputs:
      message_type:
        description: 'Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù… ØªØ¨Ù„ÛŒØºØ§ØªÛŒ'
        required: true
        default: 'airdrop'
        type: choice
        options:
          - airdrop
          - announcement
          - community
          - price_update
      include_stats:
        description: 'Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² DexScreenerØŸ'
        required: true
        default: 'true'
        type: boolean
      custom_text:
        description: 'Ù…ØªÙ† Ø§Ø¶Ø§ÙÛŒ Ø¯Ù„Ø®ÙˆØ§Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)'
        required: false
        default: ''

env:
  TELEGRAM_CHANNEL: "@CIBLOfficial"
  CIBL_GIF: "https://raw.githubusercontent.com/ciblcoin/app/main/public/videos/logo.gif"
  CONTRACT: "2Lpgt5teMe4SPp1G8x1URBk6dPRoimftdANmAsFDvkPA"

jobs:
  promote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª
        run: |
          echo "=== CIBL TELEGRAM PROMOTION ==="
          echo "ğŸ“… Ø²Ù…Ø§Ù†: $(date)"
          echo "ğŸ“¢ Ú©Ø§Ù†Ø§Ù„: @CIBLOfficial"
          echo "ğŸ¯ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…: ${{ github.event.inputs.message_type }}"

      - name: Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ
        if: ${{ github.event.inputs.include_stats == 'true' }}
        id: get_stats
        run: |
          echo "Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚ÛŒÙ…Øª Ø§Ø² DexScreener..."
          
          # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ùˆ Ù…Ø·Ù…Ø¦Ù†â€ŒØªØ±
          response=$(curl -s "https://api.dexscreener.com/latest/dex/tokens/$CONTRACT")
          
          # Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
          PRICE="0.000001"
          CHANGE="0.00"
          
          # Ø§Ú¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯
          if [ "$(echo $response | jq -r '.pairs[0] // empty')" != "" ]; then
            PRICE=$(echo $response | jq -r '.pairs[0].priceUsd // "0.000001"')
            CHANGE=$(echo $response | jq -r '.pairs[0].priceChange.h24 // "0.00"')
          fi
          
          # ÙØ±Ù…Øª Ù‚ÛŒÙ…Øª
          FORMATTED_PRICE="\$$PRICE"
          
          # ÙØ±Ù…Øª ØªØºÛŒÛŒØ±Ø§Øª
          if (( $(echo "$CHANGE >= 0" | bc -l 2>/dev/null || echo "1") )); then
            FORMATTED_CHANGE="ğŸŸ¢ +$CHANGE%"
          else
            FORMATTED_CHANGE="ğŸ”´ $CHANGE%"
          fi
          
          echo "price=$FORMATTED_PRICE" >> $GITHUB_OUTPUT
          echo "change=$FORMATTED_CHANGE" >> $GITHUB_OUTPUT
          echo "chart_url=https://dexscreener.com/solana/$CONTRACT" >> $GITHUB_OUTPUT
          
          echo "âœ… Ø¢Ù…Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!"
          echo "ğŸ’° Ù‚ÛŒÙ…Øª: $FORMATTED_PRICE"
          echo "ğŸ“ˆ ØªØºÛŒÛŒØ±Ø§Øª: $FORMATTED_CHANGE"

      - name: ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ù¾Ø³Øª
        id: create_content
        run: |
          # Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
          case "${{ github.event.inputs.message_type }}" in
            "airdrop")
              TITLE="ğŸš€ CIBL MEGA AIRDROP - LIVE NOW! ğŸš€"
              HIGHLIGHT="ğŸ”¥ BIGGEST AIRDROP EVENT ON SOLANA!"
              EMOJI="ğŸ"
              ;;
            "price_update")
              TITLE="ğŸ“ˆ CIBL PRICE SURGE - TRENDING! ğŸ“ˆ"
              HIGHLIGHT="ğŸ“Š MAJOR PRICE MOVEMENT DETECTED!"
              EMOJI="âš¡"
              ;;
            "community")
              TITLE="ğŸ‘¥ JOIN 5K+ CIBL HOLDERS COMMUNITY ğŸ‘¥"
              HIGHLIGHT="ğŸ¤ STRONGEST COMMUNITY ON SOLANA!"
              EMOJI="ğŸ’ª"
              ;;
            *)
              TITLE="ğŸŒŸ CIBL ($CIB) - SOLANA GEM ğŸŒŸ"
              HIGHLIGHT="âœ¨ NEXT BIG TOKEN ON SOLANA!"
              EMOJI="ğŸ’"
              ;;
          esac
          
          # Ø¨Ø®Ø´ Ø¢Ù…Ø§Ø±
          STATS_SECTION=""
          if [ "${{ github.event.inputs.include_stats }}" = "true" ]; then
            STATS_SECTION="<b>ğŸ“Š LIVE MARKET DATA:</b>
ğŸ’° <b>Price:</b> ${{ steps.get_stats.outputs.price }}
ğŸ“ˆ <b>24h Change:</b> ${{ steps.get_stats.outputs.change }}

"
          fi
          
          # Ù…ØªÙ† Ø³ÙØ§Ø±Ø´ÛŒ
          CUSTOM_SECTION=""
          if [ -n "${{ github.event.inputs.custom_text }}" ]; then
            CUSTOM_SECTION="\n\n<b>ğŸ“¢ SPECIAL ANNOUNCEMENT:</b>\n${{ github.event.inputs.custom_text }}\n"
          fi
          
          # Ø³Ø§Ø®Øª Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø³Øª
          POST_CONTENT=$(cat << EOF
<b>$TITLE</b>

$HIGHLIGHT

<b>ğŸ“ CONTRACT ADDRESS:</b>
<code>$CONTRACT</code>

${STATS_SECTION}<b>$EMOJI WHY CHOOSE CIBL?</b>
âœ… <b>Massive Airdrop</b> - Earn free tokens
âœ… <b>Strong Community</b> - 5,000+ holders
âœ… <b>Solana Speed</b> - Instant & cheap transactions
âœ… <b>Transparent Team</b> - Fully doxxed
âœ… <b>Huge Potential</b> - Early stage opportunity

<b>ğŸ”¥ LIMITED TIME OFFER!</b>
Early participants get bonus rewards!${CUSTOM_SECTION}

<b>â° DON'T WAIT - JOIN NOW!</b>

#CIBL #Solana #Airdrop #Crypto #DeFi #Memecoin #Web3 #Blockchain
EOF
)
          
          echo "post_content<<EOF" >> $GITHUB_OUTPUT
          echo "$POST_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Ù…ØªÙ† Ù¾Ø³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯"

      - name: Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          echo "ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…..."
          
          # Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ Ø²ÛŒØ¨Ø§
          BUTTONS='{
            "inline_keyboard": [
              [
                {"text": "ğŸŒ Official Website", "url": "https://ciblcoin.com"},
                {"text": "ğŸ Join Airdrop", "url": "https://cbl.ag"}
              ],
              [
                {"text": "ğŸ“Š Live Chart", "url": "${{ steps.get_stats.outputs.chart_url }}"},
                {"text": "ğŸ¦ Twitter", "url": "https://twitter.com/ciblcoin"}
              ],
              [
                {"text": "ğŸ’¬ Telegram Chat", "url": "https://t.me/ciblcoin"},
                {"text": "ğŸ“° News", "url": "https://t.me/CIBLOfficial"}
              ]
            ]
          }'
          
          # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª Ø¨Ø§ GIF
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"$TELEGRAM_CHANNEL\",
              \"animation\": \"$CIBL_GIF\",
              \"caption\": \"${{ steps.create_content.outputs.post_content }}\",
              \"parse_mode\": \"HTML\",
              \"reply_markup\": $BUTTONS
            }" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendAnimation")
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªÛŒØ¬Ù‡
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            MSG_ID=$(echo "$RESPONSE" | grep -o '"message_id":[0-9]*' | head -1 | cut -d: -f2)
            echo "ğŸ‰ âœ… Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!"
            echo "ğŸ“± Message ID: $MSG_ID"
            echo "ğŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø±: https://t.me/CIBLOfficial"
            
            # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            if [ -n "${{ secrets.ADMIN_CHAT_ID }}" ]; then
              curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "{
                  \"chat_id\": \"${{ secrets.ADMIN_CHAT_ID }}\",
                  \"text\": \"âœ… <b>CIBL Post Published Successfully!</b>\n\nğŸ“¢ Channel: @CIBLOfficial\nğŸ¯ Type: ${{ github.event.inputs.message_type }}\nğŸ†” Message ID: $MSG_ID\nâ° Time: $(date '+%H:%M:%S')\n\nâœ… The promotional post has been published to the channel.\",
                  \"parse_mode\": \"HTML\"
                }" \
                "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" || echo "âš ï¸ Could not send admin notification"
            fi
            
          else
            echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³Øª!"
            echo "ğŸ“„ Response: $RESPONSE"
            
            # Ø§Ø±Ø³Ø§Ù„ Ø®Ø·Ø§ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            if [ -n "${{ secrets.ADMIN_CHAT_ID }}" ]; then
              ERROR_MSG=$(echo "$RESPONSE" | grep -o '"description":"[^"]*"' | cut -d'"' -f4 || echo "Unknown error")
              
              curl -s -X POST \
                -H "Content-Type: application/json" \
                -d "{
                  \"chat_id\": \"${{ secrets.ADMIN_CHAT_ID }}\",
                  \"text\": \"âŒ <b>FAILED to publish CIBL post!</b>\n\nğŸš¨ Error: $ERROR_MSG\nğŸ“¢ Channel: @CIBLOfficial\nâ° Time: $(date '+%H:%M:%S')\n\nâš ï¸ Please check bot permissions and try again.\",
                  \"parse_mode\": \"HTML\"
                }" \
                "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" || echo "âš ï¸ Could not send error notification"
            fi
            
            exit 1
          fi

      - name: ØªÚ©Ù…ÛŒÙ„ Ø¹Ù…Ù„ÛŒØ§Øª
        run: |
          echo "========================================"
          echo "âœ… WORKFLOW COMPLETED SUCCESSFULLY!"
          echo "ğŸ“¢ Post published to @CIBLOfficial"
          echo "ğŸ¯ Type: ${{ github.event.inputs.message_type }}"
          echo "â° Finished at: $(date)"
          echo "========================================"